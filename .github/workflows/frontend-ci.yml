name: Frontend CI Pipeline

on:
  push:
    branches: ["main"]
    tags:
      - "v*"
  pull_request:
    branches: ["main"]

jobs:
  # Enforce code quality and security checks - catches commits that bypassed local hooks
  validations:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for sensitive files
        run: |
          if git ls-files | grep -E "\.env$|credentials\.json|secrets\.yaml|private.*\.key" | grep -v "\.env\.example$"; then
            echo "ERROR: Sensitive files detected in repository!"
            exit 1
          fi

      - name: Check for trailing whitespace
        run: |
          if ! git grep -I --files-with-matches --perl-regexp '\s+$' -- ':!*.md' ':!*.txt' || [ $? -eq 1 ]; then
            echo "No trailing whitespace found"
          else
            echo "ERROR: Trailing whitespace detected in files above!"
            exit 1
          fi

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npx eslint src/ --ext .js,.jsx,.ts,.tsx --max-warnings 10

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Run secrets detection
        run: |
          detect-secrets scan --baseline .secrets.baseline
          if [ $? -ne 0 ]; then
            echo "ERROR: Secrets detected in code!"
            exit 1
          fi

  build:
    # Only build on main branch or version tags
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    needs: validations
    uses: Alae-J/travelo-ci-templates/.github/workflows/docker-build.yml@main
    with:
      image-name: alaej/travelo-frontend
      artifact-name: frontend-image
      enable-cache: true
      cache-key-file: package-lock.json

  push:
    needs: build
    uses: Alae-J/travelo-ci-templates/.github/workflows/docker-push.yml@main
    with:
      image-name: alaej/travelo-frontend
      artifact-name: frontend-image
      support-version-tags: true
    secrets:
      dockerhub-username: ${{ secrets.DOCKERHUB_USERNAME }}
      dockerhub-token: ${{ secrets.DOCKERHUB_TOKEN }}

  GitOps-k8s-deploy:
    needs: push
    if: github.ref == 'refs/heads/main'
    uses: Alae-J/travelo-ci-templates/.github/workflows/gitops-deploy.yml@main
    with:
      image-name: alaej/travelo-frontend
      yaml-file: frontend.yaml
      infra-repo: yassinelamsaaf/travelo-infra
      support-version-tags: true
    secrets:
      infra-token: ${{ secrets.INFRA_REPO_TOKEN }}
